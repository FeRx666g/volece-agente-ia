{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/asignar-turno-ai",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        32,
        96
      ],
      "id": "e08b4a4b-f7e7-49ea-858c-0a3709be2da8",
      "name": "Webhook",
      "webhookId": "0e3518f2-f483-46a8-a810-0eee1bc77d21"
    },
    {
      "parameters": {
        "jsCode": "let content = null;\n\nif (items[0]?.json?.message?.content) {\n  content = items[0].json.message.content;\n} else if (items[0]?.json?.content) {\n  content = items[0].json.content;\n}\n\nif (typeof content !== 'string') {\n  throw new Error('No se encontró el contenido de OpenAI como string');\n}\n\ncontent = content.trim();\n\nif (content.startsWith('```')) {\n  content = content.replace(/^```[a-zA-Z]*\\s*/,'');\n  content = content.replace(/```$/,'');            \n  content = content.trim();\n}\n\ncontent = content.replace(/,\\s*([\\]}])/g, '$1');\n\nlet data;\ntry {\n  data = JSON.parse(content);\n} catch (e) {\n  throw new Error('No se pudo parsear la respuesta de OpenAI: ' + e.message + '\\nContenido:\\n' + content);\n}\n\nlet mejor = data.mejor_transportista || null;\nlet comentarioGlobal = data.comentario_ia || null;\nlet listaCompleta = Array.isArray(data.lista_completa)\n  ? data.lista_completa\n  : [];\n\nlistaCompleta = listaCompleta\n  .map((t) => ({\n    transportista_id: Number(t.transportista_id),\n    transportista_nombre: t.transportista_nombre,\n    vehiculo_id: t.vehiculo_id ? Number(t.vehiculo_id) : null,\n    vehiculo_placa: t.vehiculo_placa || '',\n    vehiculo_modelo: t.vehiculo_modelo || '',\n    vehiculo_tipo: t.vehiculo_tipo,\n    vehiculo_tonelaje: Number(t.vehiculo_tonelaje),\n    probabilidad: Number(t.probabilidad),\n    comentario_ia: t.comentario_ia,\n  }))\n  .sort((a, b) => (b.probabilidad || 0) - (a.probabilidad || 0));\n\nif (mejor) {\n    mejor.vehiculo_id = mejor.vehiculo_id ? Number(mejor.vehiculo_id) : null;\n}\n\nif (!mejor && listaCompleta.length > 0) {\n  mejor = {\n    transportista_id: listaCompleta[0].transportista_id,\n    transportista_nombre: listaCompleta[0].transportista_nombre,\n    vehiculo_id: listaCompleta[0].vehiculo_id, // Pasamos el ID del vehículo\n    probabilidad: listaCompleta[0].probabilidad,\n  };\n}\n\nreturn [\n  {\n    json: {\n      mejor_transportista: mejor,\n      comentario_ia: comentarioGlobal,\n      lista_completa: listaCompleta,\n    },\n  },\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        96
      ],
      "id": "07aeecfe-4ce7-42f2-9921-098dad882ca2",
      "name": "Code"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  v.id                    AS vehiculo_id,\n  v.tipo                  AS vehiculo_tipo,\n  v.tonelaje              AS vehiculo_tonelaje,\n  v.estado                AS vehiculo_estado,\n  v.placa                 AS vehiculo_placa,\n  v.transportista_id      AS transportista_id,\n  v.observaciones         AS observaciones,\n  u.first_name            AS transportista_nombre,\n  u.last_name             AS transportista_apellido,\n  u.is_active             AS transportista_activo,\n  u.rol                   AS transportista_rol\nFROM gestion_vehiculos_vehiculo v\nJOIN gestion_usuarios_usuario u\n  ON v.transportista_id = u.id\nWHERE v.estado = 'ACTIVO'        \n  AND u.rol = 'TRANSP';  \n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        240,
        96
      ],
      "id": "21ca451c-f57b-4c5e-9668-d7060c147e96",
      "name": "Execute a SQL query",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "YZkZS0KDqAsNU6fG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "\nconst webhookItems = $items(\"Webhook\");\nconst solicitudBody = webhookItems[0]?.json?.body ?? {};\n\nconst transportistasSQL = $items(\"Execute a SQL query\");\n\nconst transportistas = transportistasSQL.map(i => ({\n  transportista_id: parseInt(i.json.transportista_id, 10),\n  transportista_nombre: i.json.transportista_nombre,\n  transportista_apellido: i.json.transportista_apellido,\n  vehiculo_id: parseInt(i.json.vehiculo_id, 10),\n  vehiculo_tipo: i.json.vehiculo_tipo,\n  vehiculo_observacion: i.json.observaciones,\n  vehiculo_tonelaje: parseFloat(i.json.vehiculo_tonelaje),\n  vehiculo_placa: i.json.vehiculo_placa,\n}));\n\nconst disponibilidadSQL = $items(\"Execute a SQL query1\");\n\nconst disponibilidad = disponibilidadSQL.map(i => ({\n  transportista_id: parseInt(i.json.transportista_id, 10),\n  fechas_ocupado: i.json.fechas_ocupado || [],\n  viajes_semana: parseInt(i.json.viajes_semana, 10) || 0,\n}));\n\nconst candidatos = transportistas.map(t => {\n  const dispo = disponibilidad.find(d => d.transportista_id === t.transportista_id);\n\n  return {\n    ...t,\n    fechas_ocupado: dispo?.fechas_ocupado ?? [],\n    viajes_semana: dispo?.viajes_semana ?? 0,\n  };\n});\n\nreturn [\n  {\n    json: {\n      solicitud: {\n        id_solicitud: solicitudBody.id_solicitud ?? null,\n        tipo_carga: solicitudBody.tipo_carga ?? null,\n        origen: solicitudBody.origen ?? null,\n        destino: solicitudBody.destino ?? null,\n        fecha_solicitud: solicitudBody.fecha_solicitud ?? null,\n      },\n      candidatos\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        96
      ],
      "id": "49361208-7de3-48ed-bb7f-632bd2ae3ba8",
      "name": "Code1"
    },
    {
      "parameters": {
        "content": "**Nodo que recibe los datos de la solicitud del cliente** ",
        "height": 256,
        "width": 160,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        0
      ],
      "typeVersion": 1,
      "id": "6bc503c8-4a5d-49a2-8643-00260806cf03",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "**Nodo que consulta los transportistas activos y sus datos.** ",
        "height": 256,
        "width": 192,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        192,
        0
      ],
      "typeVersion": 1,
      "id": "9d9251e5-08b0-47cd-a754-07d03b66eb8e",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH semana AS (\n    SELECT\n        date_trunc('week', CURRENT_DATE)::date AS lunes,         -- lunes de la semana actual\n        (date_trunc('week', CURRENT_DATE)::date + interval '6 days')::date AS domingo  -- domingo\n),\ntransportistas AS (\n    SELECT DISTINCT transportista_id\n    FROM gestion_transporte_datasetturnosia\n    WHERE transportista_id IS NOT NULL\n)\nSELECT\n    t.transportista_id,\n\n    -- 1) TODAS las fechas donde está ocupado (asignado)\n    ARRAY(\n        SELECT d.fecha_turno\n        FROM gestion_transporte_datasetturnosia d\n        WHERE d.transportista_id = t.transportista_id\n          AND d.estado_solicitud = 'asignado'\n        ORDER BY d.fecha_turno\n    ) AS fechas_ocupado,\n\n    -- 2) NÚMERO DE VIAJES asignados en TODA la semana (lunes a domingo)\n    (\n        SELECT COUNT(*)\n        FROM gestion_transporte_datasetturnosia d2, semana s\n        WHERE d2.transportista_id = t.transportista_id\n          AND d2.estado_solicitud = 'asignado'\n          AND d2.fecha_turno BETWEEN s.lunes AND s.domingo\n    ) AS viajes_semana\n\nFROM transportistas t\nORDER BY t.transportista_id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        528,
        96
      ],
      "id": "8b872133-5eca-4d53-a76c-b1bf1b64bfc5",
      "name": "Execute a SQL query1",
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "YZkZS0KDqAsNU6fG",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "content": "**Nodo que consulta las fechas no disponibles de los transportistas y la cantidad de asignaciones en la semana.** ",
        "height": 256,
        "width": 304,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        416,
        0
      ],
      "typeVersion": 1,
      "id": "df080490-0c72-4712-bc42-e9dbc4f46b39",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "**Nodo que une la solicitud del cliente y las consultas SQL para el modelo de IA.** ",
        "height": 256,
        "width": 224,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        736,
        0
      ],
      "typeVersion": 1,
      "id": "074eb293-afdc-44f3-a1d0-8cd55b8012d0",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "**Nodo que ejecuta el modelo de IA según la información proporcionada.** ",
        "height": 256,
        "width": 256,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        976,
        0
      ],
      "typeVersion": 1,
      "id": "c6a8fdb4-755a-4c53-8571-38bdd54f0196",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "Eres un asistente experto en logística y gestión de flotas de transporte. Tu redacción debe ser profesional, clara, concisa y con buena ortografía.\n\nRecibirás un JSON con dos secciones:\n1. \"solicitud\": contiene id_solicitud, origen, destino, tipo_carga, fecha_solicitud y \"tipo_vehiculo\" (este último es el vehículo PREFERIDO por el cliente).\n2. \"candidatos\": lista REAL de transportistas disponibles con sus vehículos, capacidades y fechas ocupadas.\n\nREGLAS ESTRICTAS DE EVALUACIÓN:\n\n1. NO inventes datos. Usa solo la información provista.\n2. Evalúa a cada candidato basándote en estos criterios ponderados:\n\n   A) Compatibilidad del Vehículo (40%):\n      - Si el \"vehiculo_tipo\" del candidato COINCIDE con el \"tipo_vehiculo\" solicitado por el cliente, otorga la máxima puntuación en este apartado.\n      - Si NO coincide, evalúa técnicamente si el vehículo es capaz de llevar la \"tipo_carga\".\n\n   B) Disponibilidad en la Fecha (CRÍTICO - 35%):\n      - Revisa la \"fecha_solicitud\".\n      - Compara esa fecha EXCLUSIVAMENTE con las fechas exactas en la lista \"fechas_ocupado\" del candidato.\n      - REGLA DE ORO: Si la \"fecha_solicitud\" NO aparece textualmente en \"fechas_ocupado\", el vehículo está 100% DISPONIBLE.\n      - PROHIBIDO penalizar, asumir retrasos o inferir indisponibilidad basándose en fechas anteriores o posteriores (ej. \"ayer estuvo ocupado\"). Los viajes son independientes; solo importa el día exacto solicitado.\n\n   C) Capacidad y Balanceo (25%):\n      - El \"vehiculo_tonelaje\" debe ser suficiente.\n      - Prioriza a quienes tengan menos \"viajes_semana\".\n\n3. Cálculo de Probabilidades:\n   - Normaliza las puntuaciones para obtener una probabilidad entre 0.00 y 1.00.\n   - La suma de todas las probabilidades debe ser EXACTAMENTE 1.00.\n\nREGLAS DE REDACCIÓN Y COMENTARIOS:\n\n- \"comentario_ia\": Sé sincero y directo.\n- Si el vehículo recomendado NO es el que el cliente pidió, explica: \"El cliente solicitó [Vehículo pedido], pero...\" y justifica técnicamente.\n- Si el vehículo coincide, confírmalo: \"Coincide con el vehículo solicitado y tiene disponibilidad confirmada.\"\n- NUNCA menciones \"posible indisponibilidad\" por viajes en días previos. Si la fecha no está en la lista de ocupados, está libre.\n\nFORMATO DE RESPUESTA JSON (NO MODIFICAR ESTRUCTURA):\n\n{\n  \"mejor_transportista\": {\n    \"transportista_id\": <number>,\n\"vehiculo_id\": <number>,\n    \"transportista_nombre\": \"<string nombre + apellido>\",\n    \"probabilidad\": <number>\n  },\n  \"comentario_ia\": \"<Resumen general>\",\n  \"lista_completa\": [\n    {\n      \"transportista_id\": <number>,\n\"vehiculo_id\": <number>,\n\n      \"transportista_nombre\": \"<string nombre + apellido>\",\n\"vehiculo_placa\": \"<string>\",\n      \"vehiculo_tipo\": \"<string>\",\n      \"vehiculo_tonelaje\": <number>,\n      \"probabilidad\": <number>,\n      \"comentario_ia\": \"<Explicación específica>\"\n    }\n  ]\n}",
              "role": "system"
            },
            {
              "content": "=Aquí están los datos que debes analizar en formato JSON:\n\n{{ JSON.stringify($json, null, 2) }}\n"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        992,
        96
      ],
      "id": "3a5161a5-402d-40ba-8f32-8bb408fc0fb8",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "qNvlmfAYjJAFRZNX",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "content": "**Nodo final que formatea la respuesta del modelo para el front-end.** ",
        "height": 256,
        "width": 192,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1248,
        0
      ],
      "typeVersion": 1,
      "id": "2d3a3e06-fa75-487c-ab97-f8f1caccaddd",
      "name": "Sticky Note5"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7facb1c5-5fcc-4092-a8bc-91e6f704072c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2f98ed89d022fa1d8f90046f81a645256130dd131c12216bf67a9faa1fe9f709"
  },
  "id": "6o6y4g4CVXGDngWk",
  "tags": []
}